<!DOCTYPE html>
<html>

<head>
    <title>Mapbox GL JS Sky Demo</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href='../../src/css/mapbox-gl.css' rel='stylesheet' type="text/css" />
    <style>
        body {
            margin: 0;
            padding: 0
        }

        html,
        body,
        #map {
            height: 100%;
        }

        #inputs {
            position: absolute;
            top: 0;
            left: 0;
            padding: 10px;
        }
    </style>
</head>

<body>
    <script src='../../dist/mapbox-gl-dev.js'></script>
    <script src='../../debug/access_token_generated.js'></script>
    <div id='map'></div>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js'></script>
    <script type="module">
        let date = new Date(`2022-04-21 12:00:00`);

        console.log(date);

        var map = window.map = new mapboxgl.Map({
            container: 'map',
            zoom: 12.1,
            center: [-114.34411, 32.6141],
            pitch: 0,
            bearing: 0,
            style: 'mapbox://styles/mapbox/satellite-v9',
            hash: true,
        });

        function render() {
            window.requestAnimationFrame(() => {
                render();
            });

            date.setTime(date.getTime() + 60 * 1000);

            map.setPaintProperty('sky', 'sky-atmosphere-sun', getSunPosition(date));

            map.triggerRepaint();
        }


        map.on('style.load', function () {
            map.addSource("vector-composite", {
                type: "vector",
                url: "mapbox://mapbox.mapbox-streets-v8,mapbox.mapbox-terrain-v2"
            });

            map.addLayer({
                id: "vector-water",
                type: "fill",
                source: "vector-composite",
                "source-layer": "water",
                paint: {
                    "fill-color": "hsl(196, 80%, 70%)"
                }
            });

            map.addSource('mapbox-dem', {
                "type": "raster-dem",
                "url": "mapbox://mapbox.terrain-rgb",
                "tileSize": 512,
                "maxzoom": 14
            });
            map.setTerrain({ "source": "mapbox-dem", "exaggeration": 1.5 });


            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-opacity': ['interpolate', ['linear'],
                        ['zoom'],
                        0, 0,
                        5, 0.3,
                        8, 1],
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': getSunPosition(),
                    'sky-atmosphere-sun-intensity': 5,
                }
            });

            render();
        });

        function getSunPosition(date) {
            const center = map.getCenter();
            // eslint-disable-next-line no-undef
            var sunPos = SunCalc.getPosition(date || Date.now(), center.lat, center.lng);
            var sunAzimuth = 180 + sunPos.azimuth * 180 / Math.PI;
            var sunAltitude = 90 - sunPos.altitude * 180 / Math.PI;
            // console.log([sunAzimuth, sunAltitude]);
            return [sunAzimuth, sunAltitude];
        }



    </script>
</body>

</html>